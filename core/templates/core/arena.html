<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arena KMS - Desafios 1x1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #121212; color: #ffffff; font-family: 'Inter', sans-serif; padding-bottom: 50px; }
        .back-link { color: #888; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 25px; transition: 0.2s; }
        .back-link:hover { color: #fff; }
        
        .glass-card { background: #1e1e1e; border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 20px; }
        
        /* Tanques de Batalha (Versão Slim) */
        .tanque-wrapper-slim { position: relative; width: 80px; height: 250px; margin: 0 auto; }
        .tanque-externo-slim { width: 100%; height: 100%; border: 4px solid #333; border-radius: 15px 15px 30px 30px; position: relative; background: rgba(255, 255, 255, 0.05); overflow: hidden; z-index: 1; }
        
        .liquido-azul { width: 100%; background: linear-gradient(180deg, #00d2ff 0%, #3a7bd5 100%); position: absolute; bottom: 0; transition: height 1.5s ease-in-out; box-shadow: 0 0 15px rgba(0, 210, 255, 0.5); }
        .liquido-vermelho { width: 100%; background: linear-gradient(180deg, #ff416c 0%, #ff4b2b 100%); position: absolute; bottom: 0; transition: height 1.5s ease-in-out; box-shadow: 0 0 15px rgba(255, 65, 108, 0.5); }
        
        .porcentagem-badge-slim { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; font-weight: 900; text-shadow: 0 0 8px rgba(0,0,0,0.8); z-index: 5; color: white; }

        .vs-badge { background: linear-gradient(135deg, #ffd700, #ff8c00); color: black; font-weight: 900; padding: 5px 15px; border-radius: 20px; font-size: 1.2rem; display: inline-block; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); margin: 0 10px; }
        
        /* Modal de Criar Desafio */
        .modal-content-dark { background: #1a1d20; border: 1px solid #333; border-radius: 15px; }
        .form-control-dark { background: #121212; border: 1px solid #444; color: white; }
        .form-control-dark:focus { background: #121212; color: white; border-color: #00d2ff; box-shadow: none; }
    </style>
</head>
<body>

<div class="container py-4" style="max-width: 600px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="{% url 'dashboard' %}" class="back-link mb-0">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <button class="btn fw-bold" style="background-color: #ff4b2b; color: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);" data-bs-toggle="modal" data-bs-target="#novoDesafioModal">
            <i class="bi bi-crosshair"></i> Lançar Desafio
        </button>
    </div>

    <h2 class="fw-900 mb-4 text-center" style="letter-spacing: 1px;">ARENA DE <span style="color: #ff4b2b;">BATALHA</span></h2>

    {% for d in desafios %}
        
        {% if d.status == 'pendente' %}
        <div class="glass-card" style="border-left: 4px solid #ffca28;">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="fw-bold mb-1 text-warning"><i class="bi bi-hourglass-split"></i> Desafio Pendente</h5>
                    <p class="mb-0 text-white"><strong>{{ d.desafiante }}</strong> desafiou <strong>{{ d.desafiado }}</strong>!</p>
                    <small class="text-muted">Meta: {{ d.alvo_km }}km em {{ d.prazo_dias }} dias.</small>
                </div>
            </div>
            
            {% if request.user.first_name == d.desafiado %}
            <div class="mt-3 d-flex gap-2">
                <a href="{% url 'responder_desafio' d.id 'aceitar' %}" class="btn btn-success flex-grow-1 fw-bold rounded-pill"><i class="bi bi-check-circle-fill"></i> Aceitar</a>
                <a href="{% url 'responder_desafio' d.id 'recusar' %}" class="btn btn-outline-danger flex-grow-1 fw-bold rounded-pill"><i class="bi bi-x-circle-fill"></i> Recusar</a>
            </div>
            {% endif %}
        </div>

        {% elif d.status == 'ativo' %}
        <div class="glass-card" id="cartaoDesafio_{{ d.id }}" style="position: relative; overflow: hidden; border-color: rgba(255, 75, 43, 0.3);">
            
            <div style="position: absolute; top: -50px; left: -50px; width: 100px; height: 100px; background: #00d2ff; filter: blur(60px); opacity: 0.3;"></div>
            <div style="position: absolute; bottom: -50px; right: -50px; width: 100px; height: 100px; background: #ff416c; filter: blur(60px); opacity: 0.3;"></div>

            <div class="text-center mb-4" style="position: relative; z-index: 2;">
                <h4 class="fw-900 text-uppercase mb-0" style="letter-spacing: 2px;">Corrida até {{ d.alvo_km|floatformat:0 }}KM</h4>
                <small class="text-muted fw-bold">Prazo: {{ d.prazo_dias }} dias</small>
            </div>

            <div class="d-flex justify-content-center align-items-end mb-4" style="position: relative; z-index: 2;">
                
                <div class="text-center">
                    <h5 class="fw-bold mb-3" style="color: #00d2ff;">{{ d.desafiante }}</h5>
                    <div class="tanque-wrapper-slim">
                        <div class="porcentagem-badge-slim">{{ d.porc_desafiante|floatformat:0 }}%</div>
                        <div class="tanque-externo-slim">
                            <div class="liquido-azul" style="height: {{ d.porc_desafiante }}%;"></div>
                        </div>
                    </div>
                    <h4 class="fw-900 mt-3 mb-0 text-white">{{ d.km_desafiante|floatformat:1 }} <small class="text-muted" style="font-size: 0.8rem;">km</small></h4>
                </div>

                <div class="vs-badge align-self-center mx-4 mb-5">VS</div>

                <div class="text-center">
                    <h5 class="fw-bold mb-3" style="color: #ff4b2b;">{{ d.desafiado }}</h5>
                    <div class="tanque-wrapper-slim">
                        <div class="porcentagem-badge-slim">{{ d.porc_desafiado|floatformat:0 }}%</div>
                        <div class="tanque-externo-slim">
                            <div class="liquido-vermelho" style="height: {{ d.porc_desafiado }}%;"></div>
                        </div>
                    </div>
                    <h4 class="fw-900 mt-3 mb-0 text-white">{{ d.km_desafiado|floatformat:1 }} <small class="text-muted" style="font-size: 0.8rem;">km</small></h4>
                </div>

            </div>

            <button onclick="partilharDesafio({{ d.id }})" class="btn w-100 fw-bold py-2 rounded-pill shadow-sm btn-partilhar" style="background-color: #25D366; color: white; position: relative; z-index: 2;">
                <i class="bi bi-whatsapp me-2"></i> Provocar no WhatsApp
            </button>

        </div>
        {% endif %}

    {% empty %}
        <div class="text-center py-5">
            <i class="bi bi-shield-slash" style="font-size: 4rem; color: #444;"></i>
            <h4 class="mt-3 fw-bold text-muted">A Arena está vazia.</h4>
            <p class="text-muted">Desafie alguém para aquecer os motores!</p>
        </div>
    {% endfor %}

</div>

<div class="modal fade" id="novoDesafioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-content-dark">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title text-white fw-bold"><i class="bi bi-crosshair text-danger"></i> Escolha o seu Alvo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{% url 'criar_desafio' %}" method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label class="form-label text-muted fw-bold">Quem quer desafiar?</label>
                        <select name="desafiado" class="form-select form-control-dark" required>
                            <option value="">Selecione um corredor...</option>
                            {% for u in usuarios_disponiveis %}
                                <option value="{{ u }}">{{ u }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label text-muted fw-bold">Meta (KMs)</label>
                            <input type="number" name="alvo_km" class="form-control form-control-dark" value="30" required>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label text-muted fw-bold">Prazo (Dias)</label>
                            <input type="number" name="prazo_dias" class="form-control form-control-dark" value="7" required>
                        </div>
                    </div>

                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="submit" class="btn fw-bold w-100 py-2 rounded-pill" style="background: #ff4b2b; color: white;">Lançar Desafio!</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    function partilharDesafio(id) {
        const cartao = document.getElementById('cartaoDesafio_' + id);
        const botao = cartao.querySelector('.btn-partilhar');
        
        // Esconde o botão de WhatsApp temporariamente para não sair na foto
        botao.style.display = 'none';
        
        html2canvas(cartao, {
            scale: 3, 
            backgroundColor: '#121212',
            useCORS: true
        }).then(canvas => {
            // Devolve o botão
            botao.style.display = 'block';
            
            // Faz o download da imagem
            const link = document.createElement('a');
            link.download = 'Duelo_KMS.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
