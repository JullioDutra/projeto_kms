<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criador de Rotas</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* Estilos Gerais */
        body { 
            background-color: #121212; 
            color: #fff; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        }

        .back-link { 
            color: #888; 
            text-decoration: none; 
            display: inline-block; 
            margin-bottom: 15px; 
            transition: color 0.3s;
        }
        
        .back-link:hover { color: #ff6b00; }

        /* Mapa e Filtro Dark */
        #map { 
            height: 60vh; 
            width: 100%; 
            border-radius: 15px; 
            border: 2px solid #333; 
            z-index: 1; 
        }

        .leaflet-tile-pane {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        /* Painel de Controle */
        .painel-flutuante { 
            background: #1a1d20; 
            padding: 20px; 
            border-radius: 15px; 
            margin-top: -30px; 
            position: relative; 
            z-index: 10; 
            box-shadow: 0 -10px 20px rgba(0,0,0,0.5); 
            border: 1px solid rgba(255,255,255,0.1); 
        }

        .distancia-display { 
            font-size: 2.5rem; 
            font-weight: 900; 
            color: #ff6b00; 
            line-height: 1; 
        }

        .form-control { 
            background-color: #2b2b2b !important; 
            border: 1px solid #444 !important; 
            color: white !important; 
        }

        .form-control::placeholder { color: #777; }

        .btn-gradient {
            background: linear-gradient(135deg, #ff6b00, #ffca28); 
            color: black;
            border: none;
            transition: transform 0.2s;
        }

        .btn-gradient:hover {
            transform: scale(1.02);
            color: black;
        }
    </style>
</head>
<body>

<div class="container py-3" style="max-width: 600px;">
    <a href="{% url 'dashboard' %}" class="back-link">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
    
    <div class="mb-3">
        <h3 class="fw-bold mb-1"><i class="bi bi-map text-warning"></i> Desenhar Rota</h3>
        <p class="text-muted small">Clique no mapa para ligar os pontos e desenhar o seu percurso.</p>
    </div>

    <div id="map"></div>

    <div class="painel-flutuante">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Distância Total</small>
                <div class="distancia-display" id="distanciaTexto">
                    0.00 <span style="font-size: 1rem; color:#888;">km</span>
                </div>
            </div>
            <button class="btn btn-outline-danger rounded-pill px-3" onclick="limparMapa()">
                <i class="bi bi-trash"></i> Limpar
            </button>
        </div>

        <div class="mb-3">
            <input type="text" id="nomeRota" class="form-control mb-2" placeholder="Nome da Rota (ex: Longão de Sábado)">
            <input type="text" id="nomeCriador" class="form-control" placeholder="Seu Nome">
        </div>

        <button id="btnSalvar" class="btn btn-gradient w-100 fw-bold py-3 rounded-pill" onclick="salvarRota()">
            <i class="bi bi-floppy-fill"></i> SALVAR ROTA NA COMUNIDADE
        </button>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- Configurações Iniciais ---
    const map = L.map('map').setView([-16.3267, -48.9528], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // --- Estado da Aplicação ---
    let coordenadas = []; 
    let distanciaTotal = 0;
    let marcadores = [];
    let ultimoPonto = null;

    const linhaDesenhada = L.polyline([], {
        color: '#00d2ff', 
        weight: 5, 
        opacity: 0.8
    }).addTo(map);

    // --- Eventos ---
    map.on('click', function(e) {
        const latlng = e.latlng;
        
        // Criar marcador visual
        const marcador = L.circleMarker(latlng, {
            radius: 5, 
            color: '#fff', 
            fillColor: '#ffca28', 
            fillOpacity: 1
        }).addTo(map);
        
        marcadores.push(marcador);

        if (!ultimoPonto) {
            // Primeiro ponto da rota
            coordenadas.push([latlng.lat, latlng.lng]);
            linhaDesenhada.setLatLngs(coordenadas);
            ultimoPonto = latlng;
        } else {
            // Buscar rota via OSRM (Caminhada)
            const url = `https://router.project-osrm.org/route/v1/foot/${ultimoPonto.lng},${ultimoPonto.lat};${latlng.lng},${latlng.lat}?geometries=geojson`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if(data.code === 'Ok') {
                        const rotaOSRM = data.routes[0];
                        const geometria = rotaOSRM.geometry.coordinates;
                        
                        // Acumular distância
                        distanciaTotal += (rotaOSRM.distance / 1000);
                        atualizarDisplayDistancia();
                        
                        // Adicionar pontos da geometria à linha (convertendo para LatLng)
                        for (let i = 1; i < geometria.length; i++) {
                            coordenadas.push([geometria[i][1], geometria[i][0]]);
                        }
                        
                        linhaDesenhada.setLatLngs(coordenadas);
                        ultimoPonto = latlng;
                    } else {
                        alert("Não foi possível encontrar uma via para este ponto!");
                        map.removeLayer(marcador);
                        marcadores.pop();
                    }
                })
                .catch(error => {
                    console.error("Erro OSRM:", error);
                    alert("Erro ao traçar a rota.");
                });
        }
    });

    // --- Funções Auxiliares ---
    function atualizarDisplayDistancia() {
        document.getElementById('distanciaTexto').innerHTML = 
            `${distanciaTotal.toFixed(2)} <span style="font-size: 1rem; color:#888;">km</span>`;
    }

    function limparMapa() {
        coordenadas = [];
        distanciaTotal = 0;
        ultimoPonto = null;
        linhaDesenhada.setLatLngs([]);
        marcadores.forEach(m => map.removeLayer(m));
        marcadores = [];
        atualizarDisplayDistancia();
    }

    function salvarRota() {
        const nome = document.getElementById('nomeRota').value;
        const criador = document.getElementById('nomeCriador').value;
        const btnSalvar = document.getElementById('btnSalvar');

        if (!nome || !criador || coordenadas.length < 2) {
            alert("Preencha todos os campos e desenhe uma rota no mapa!");
            return;
        }

        const dados = {
            nome: nome,
            criador: criador,
            distancia: distanciaTotal.toFixed(2),
            coordenadas: coordenadas 
        };

        // UI Feedback
        const textoOriginal = btnSalvar.innerHTML;
        btnSalvar.innerHTML = '<i class="bi bi-hourglass-split"></i> SALVANDO...';
        btnSalvar.disabled = true;

        fetch("{% url 'criar_rota' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'sucesso') {
                window.location.href = "{% url 'listar_rotas' %}"; 
            } else {
                alert("Erro ao salvar: " + data.mensagem);
                btnSalvar.innerHTML = textoOriginal;
                btnSalvar.disabled = false;
            }
        })
        .catch(err => {
            console.error(err);
            btnSalvar.innerHTML = textoOriginal;
            btnSalvar.disabled = false;
        });
    }
</script>

</body>
</html>
